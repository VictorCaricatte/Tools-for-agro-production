<!-- 
 ==============================================================================
 Author:       Victor S Caricatte De Araújo
 Email:        victorleniwys@gmail.com or victorsc@ufmg.br
 Intitution:   Universidade federal de Minas Gerais
 Version:      1.2.7
 Date:         May,16
 ...................................
 ==============================================================================
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Estrutura e Valores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para exportação PDF e Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark gray text */
        }
        .table-container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
        }
        .table-category {
            margin-bottom: 2rem;
        }
        .table-category h2 {
            font-size: 1.5rem; /* Increased font size for category titles */
            font-weight: 600;
            color: #374151; /* Medium-dark gray for titles */
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb; /* Separator line */
            padding-bottom: 0.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        th {
            background-color: #f9fafb; /* Lighter gray for table headers */
            font-weight: 600;
            color: #4b5563;
            cursor: pointer; /* For sorting indication */
        }
        th .sort-icon {
            margin-left: 0.25rem;
            opacity: 0.5;
        }
        th:hover .sort-icon {
            opacity: 1;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #3b82f6; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        select {
            width: auto;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: white;
        }
        select:focus {
            outline: none;
            border-color: #3b82f6; /* Blue focus border */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .total-row td {
            font-weight: 600;
            background-color: #f0fdf4; /* Light green for total rows */
            color: #15803d;
        }
        .action-buttons button, .global-actions button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-add {
            background-color: transparent;
            color: #22c55e; /* Green text */
            border: none;
        }
        .btn-add:hover {
            color: #16a34a;
            background-color: transparent;
        }
        .btn-remove {
            background-color: transparent;
            color: #ef4444; /* Red text */
            padding: 0.3rem 0.6rem; /* Smaller padding for remove button */
            border: none;
        }
        .btn-remove:hover {
            color: #dc2626;
            background-color: transparent;
        }
        .btn-export-pdf {
            background-color: #3b82f6; /* Blue */
            color: white;
        }
        .btn-export-pdf:hover {
            background-color: #2563eb;
        }
        .btn-export-excel {
            background-color: #10b981; /* Emerald */
            color: white;
        }
        .btn-export-excel:hover {
            background-color: #059669;
        }
        .btn-clear {
            background-color: #f97316; /* Orange */
            color: white;
        }
        .btn-clear:hover {
            background-color: #ea580c;
        }
        .global-actions {
            display: flex;
            justify-content: space-between; /* Align items with space between */
            align-items: center; /* Vertically align items */
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .search-filter-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .search-filter-container input[type="text"] {
            min-width: 250px; /* Ensure search input is wide enough */
        }
        .totals-summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #e0f2fe; /* Light blue for summary */
            border: 1px solid #bae6fd;
            border-radius: 0.5rem;
            text-align: right;
        }
        .totals-summary h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #0c4a6e; /* Darker blue for summary title */
        }
        .totals-summary p {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #075985;
        }
        .instructions {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #fffbeb; /* Light yellow for instructions */
            border: 1px solid #fef3c7;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #713f12;
        }
        .instructions h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .instructions ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        /* For sort icons */
        .sort-icon::after {
            content: '\2195'; /* Up-down arrow */
            opacity: 0.5;
        }
        .sort-icon.asc::after {
            content: '\2191'; /* Up arrow */
            opacity: 1;
        }
        .sort-icon.desc::after {
            content: '\2193'; /* Down arrow */
            opacity: 1;
        }
        /* Hide elements meant only for PDF export from screen */
        .pdf-only {
            display: none;
        }
        /* Styles for PDF export - to be used by html2pdf.js if needed */
        @media print {
            body {
                font-family: 'Inter', sans-serif; /* Ensure font consistency */
                -webkit-print-color-adjust: exact; /* Ensures background colors are printed in Chrome/Safari */
                print-color-adjust: exact; /* Standard property */
            }
            .no-print {
                display: none !important;
            }
            .pdf-only {
                display: block !important;
            }
            .table-container, .global-actions, .totals-summary, .instructions {
                box-shadow: none;
                border: 1px solid #ccc;
                margin-bottom: 1rem;
            }
            table {
                font-size: 9pt;
                page-break-inside: avoid;
                width: 100%;
            }
            th, td {
                padding: 4pt 6pt;
            }
            input[type="text"], input[type="number"], select {
                 border: none;
                 padding: 2px;
                 background-color: transparent; /* Make inputs look like text */
                 width: auto; /* Adjust width for content */
                 display: inline; /* Display as inline for PDF */
            }
            /* Attempt to show input values in PDF */
            input[type="text"]::after, input[type="number"]::after {
                 content: attr(value);
            }
        }
        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .notification.show {
            opacity: 1;
        }
        /* Unidade de medida container */
        .unidade-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .unidade-container input {
            flex: 1;
        }
        .unidade-container select {
            width: auto;
            min-width: 70px;
        }
    </style>
</head>
<body class="p-6 md:p-10">
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Planilha Estrutura e Valores</h1>
    </header>

    <div class="global-actions no-print">
        <div class="search-filter-container">
            <input type="text" id="globalSearch" placeholder="Buscar em todas as tabelas..." class="border-gray-300 focus:ring-blue-500 focus:border-blue-500">
            <!-- Filter button could be added here if more complex filtering is needed -->
        </div>
        <div>
            <button id="exportPdfBtn" class="btn-export-pdf">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-pdf-fill" viewBox="0 0 16 16">
                    <path d="M5.523 12.424c.14-.082.293-.162.459-.238a7.878 7.878 0 0 1-.45.606c-.28.337-.498.516-.635.572a.266.266 0 0 1-.035.012.282.282 0 0 1-.026-.044c-.056-.11-.054-.226.03-.335.078-.097.224-.24.401-.382z"/>
                    <path fill-rule="evenodd" d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2.5z"/>
                    <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.658-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.375-.038.563a.84.84 0 0 1-.23.518c-.203.226-.534.446-.92.624a5.48 5.48 0 0 0-1.305.794c-.057.035-.114.07-.17.107a1.06 1.06 0 0 0-.117.238.72.72 0 0 0 .03.285.64.64 0 0 0 .11.19c.097.1.248.193.436.26.19.07.407.11.614.09.142-.014.277-.05.39-.095a.1.1 0 0 1 .11.01.12.12 0 0 1 .01.111.12.12 0 0 1-.029.092c-.042.04-.12.06-.2.07a1.426 1.426 0 0 1-.47.03c-.283-.005-.599-.041-.909-.11a1.99 1.99 0 0 1-.908-.399z"/>
                </svg>
                Exportar para PDF
            </button>
            <button id="exportExcelBtn" class="btn-export-excel">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel-fill" viewBox="0 0 16 16">
                    <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM5.884 6.68 8 9.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 10l2.233 2.68a.5.5 0 0 1-.768.64L8 10.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 10 5.116 7.32a.5.5 0 1 1 .768-.64z"/>
                </svg>
                Exportar para Excel
            </button>
            <button id="clearDataBtn" class="btn-clear">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                    <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                </svg>
                Limpar Dados
            </button>
        </div>
    </div>

    <main id="planilhaCompleta">
        <!-- Categories will be dynamically generated or hardcoded here -->
        <!-- Example for one category -->
        <div class="table-container" id="category-infraestrutura">
            <div class="table-category">
                <h2>Infraestrutura</h2>
                <div class="overflow-x-auto">
                    <table data-category-id="infraestrutura">
                        <thead>
                            <tr>
                                <th data-column="item">Item <span class="sort-icon"></span></th>
                                <th data-column="quantidade">Quantidade <span class="sort-icon"></span></th>
                                <th data-column="valorUnitario">Valor Unitário (R$) <span class="sort-icon"></span></th>
                                <th data-column="valorTotal">Valor Total (R$) <span class="sort-icon"></span></th>
                                <th data-column="depreciacao">Depreciação (R$) <span class="sort-icon"></span></th>
                                <th class="no-print">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3" class="text-right font-semibold">Total da Categoria:</td>
                                <td data-total="valorTotal">R$ 0,00</td>
                                <td data-total="depreciacao">R$ 0,00</td>
                                <td class="no-print"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-4 text-right no-print">
                    <button class="btn-add add-row-btn" data-category-id="infraestrutura">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                        </svg>
                        Adicionar Item
                    </button>
                </div>
            </div>
        </div>

        <!-- Other categories will follow the same structure -->

    </main>

    <div class="totals-summary">
        <h3>Resumo Geral da Planilha</h3>
        <p>Valor Total Geral: <span id="grandTotalValor">R$ 0,00</span></p>
        <p>Depreciação Total Geral: <span id="grandTotalDepreciacao">R$ 0,00</span></p>
    </div>

    <div class="instructions no-print">
        <h4>Instruções de Uso:</h4>
        <ul>
            <li>Clique em "Adicionar Item" para incluir novas linhas em cada categoria.</li>
            <li>Preencha os campos "Item", "Quantidade", "Valor Unitário" e "Depreciação". O "Valor Total" é calculado automaticamente.</li>
            <li>Selecione a unidade de medida apropriada para cada item (KG, G, MM, M, etc.).</li>
            <li>Na aba "Equipe", o campo "Encargos Sociais" é calculado automaticamente com base no salário.</li>
            <li>Na aba "Serviços", informe o tempo em meses ou anos conforme necessário.</li>
            <li>Clique nos cabeçalhos das colunas para ordenar os dados.</li>
            <li>Utilize o campo "Buscar" para filtrar itens em todas as tabelas.</li>
            <li>Para remover um item, clique no ícone de lixeira (<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash3-fill inline" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/></svg>) na linha correspondente.</li>
            <li>Exporte a planilha completa para PDF ou Excel utilizando os botões no topo.</li>
            <li>"Limpar Dados" removerá todas as informações inseridas (use com cuidado!).</li>
            <li>Os dados são salvos automaticamente no navegador. Não serão perdidos ao recarregar a página.</li>
        </ul>
    </div>

    <!-- Notification element -->
    <div id="notification" class="notification">Dados salvos com sucesso!</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Definição das categorias
        const categories = [
            { id: 'infraestrutura', name: 'Infraestrutura', items: [] },
            { id: 'equipamentos', name: 'Equipamentos e Utensílios', items: [] },
            { id: 'equipe', name: 'Equipe', items: [] },
            { id: 'custos', name: 'Custos', items: [] },
            { id: 'servicos', name: 'Serviços', items: [] },
            { id: 'insumos', name: 'Insumos e Materiais de Consumo', items: [] }
        ];

        const mainContainer = document.getElementById('planilhaCompleta');
        const grandTotalValorEl = document.getElementById('grandTotalValor');
        const grandTotalDepreciacaoEl = document.getElementById('grandTotalDepreciacao');
        const notification = document.getElementById('notification');

        // Unidades de medida disponíveis
        const unidadesMedida = [
            'un', 'KG', 'g', 'mg', 'L', 'mL', 'm', 'cm', 'mm', 'km', 'm²', 'ha', 'm³', 'T'
        ];

        // Função para mostrar notificação
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Função para formatar valores monetários
        function formatCurrency(value) {
            return `R$ ${parseFloat(value).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Função para converter string de moeda para número
        function parseCurrency(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace(/[^\d,.-]/g, '').replace('.', '').replace(',', '.')) || 0;
            }
            return parseFloat(value) || 0;
        }

        // Função para criar ID único para cada linha
        function createRowId() {
            return `row-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }

        // Função para calcular encargos sociais (aproximadamente 80% do salário)
        function calcularEncargosSociais(salario) {
            return salario * 0.8; // 80% do salário como encargos sociais
        }

        // Função para renderizar uma linha de tabela
        function renderRow(categoryId, item = { id: createRowId(), item: '', quantidade: 0, valorUnitario: 0, depreciacao: 0, unidade: 'un', encargos: 0, tempo: 0, periodoTempo: 'MÊS' }) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-row-id', item.id);
            
            // Verificar se é a categoria "equipe" para mostrar encargos sociais em vez de depreciação
            if (categoryId === 'equipe') {
                tr.innerHTML = `
                    <td><input type="text" class="item-input w-full p-1 border rounded" value="${item.item}" placeholder="Nome do funcionário"></td>
                    <td><input type="number" class="quantidade-input w-full p-1 border rounded" value="${item.quantidade}" min="0" step="any" placeholder="Quantidade"></td>
                    <td><input type="number" class="valor-unitario-input w-full p-1 border rounded" value="${item.valorUnitario}" min="0" step="0.01" placeholder="Salário"></td>
                    <td class="valor-total-cell">${formatCurrency(item.quantidade * item.valorUnitario)}</td>
                    <td><input type="number" class="encargos-input w-full p-1 border rounded" value="${item.encargos || calcularEncargosSociais(item.valorUnitario)}" min="0" step="0.01" readonly></td>
                    <td class="no-print"><button class="btn-remove remove-row-btn" data-category-id="${categoryId}" data-row-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                        </svg>
                    </button></td>
                `;
            } 
            // Verificar se é a categoria "servicos" para mostrar tempo em vez de quantidade
            else if (categoryId === 'servicos') {
                tr.innerHTML = `
                    <td><input type="text" class="item-input w-full p-1 border rounded" value="${item.item}" placeholder="Nome do serviço"></td>
                    <td class="unidade-container">
                        <input type="number" class="tempo-input w-full p-1 border rounded" value="${item.tempo || item.quantidade}" min="0" step="any" placeholder="Tempo">
                        <select class="periodo-tempo-select p-1 border rounded">
                            <option value="MÊS" ${(item.periodoTempo || 'MÊS') === 'MÊS' ? 'selected' : ''}>MÊS</option>
                            <option value="ANO" ${(item.periodoTempo || 'MÊS') === 'ANO' ? 'selected' : ''}>ANO</option>
                        </select>
                    </td>
                    <td><input type="number" class="valor-unitario-input w-full p-1 border rounded" value="${item.valorUnitario}" min="0" step="0.01" placeholder="Valor por período"></td>
                    <td class="valor-total-cell">${formatCurrency((item.tempo || item.quantidade) * item.valorUnitario)}</td>
                    <td><input type="number" class="depreciacao-input w-full p-1 border rounded" value="${item.depreciacao}" min="0" step="0.01" placeholder="Depreciação"></td>
                    <td class="no-print"><button class="btn-remove remove-row-btn" data-category-id="${categoryId}" data-row-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                        </svg>
                    </button></td>
                `;
            }
            // Para as demais categorias
            else {
                tr.innerHTML = `
                    <td><input type="text" class="item-input w-full p-1 border rounded" value="${item.item}" placeholder="Nome do item"></td>
                    <td class="unidade-container">
                        <input type="number" class="quantidade-input w-full p-1 border rounded" value="${item.quantidade}" min="0" step="any" placeholder="Quantidade">
                        <select class="unidade-select p-1 border rounded">
                            ${unidadesMedida.map(un => `<option value="${un}" ${(item.unidade || 'un') === un ? 'selected' : ''}>${un}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" class="valor-unitario-input w-full p-1 border rounded" value="${item.valorUnitario}" min="0" step="0.01" placeholder="Valor unitário"></td>
                    <td class="valor-total-cell">${formatCurrency(item.quantidade * item.valorUnitario)}</td>
                    <td><input type="number" class="depreciacao-input w-full p-1 border rounded" value="${item.depreciacao}" min="0" step="0.01" placeholder="Depreciação"></td>
                    <td class="no-print"><button class="btn-remove remove-row-btn" data-category-id="${categoryId}" data-row-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                        </svg>
                    </button></td>
                `;
            }

            // Adicionar event listeners para inputs
            tr.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => {
                    updateCalculations(categoryId, item.id);
                    saveToLocalStorage();
                });
                input.addEventListener('change', () => {
                    updateCalculations(categoryId, item.id);
                    saveToLocalStorage();
                });
            });
            
            // Event listener para botão de remover
            tr.querySelector('.remove-row-btn').addEventListener('click', () => {
                removeRow(categoryId, item.id);
                saveToLocalStorage();
            });
            
            return tr;
        }

        // Função para renderizar uma categoria
        function renderCategory(category) {
            // Verificar se é a categoria "equipe" para mostrar encargos sociais em vez de depreciação
            const depreciacaoLabel = category.id === 'equipe' ? 'Encargos Sociais (R$)' : 'Depreciação (R$)';
            // Verificar se é a categoria "servicos" para mostrar tempo em vez de quantidade
            const quantidadeLabel = category.id === 'servicos' ? 'Tempo' : 'Quantidade';
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'table-container';
            categoryDiv.id = `category-${category.id}`;
            categoryDiv.innerHTML = `
                <div class="table-category">
                    <h2>${category.name}</h2>
                    <div class="overflow-x-auto">
                        <table data-category-id="${category.id}" class="w-full">
                            <thead>
                                <tr>
                                    <th data-column="item" class="cursor-pointer">Item <span class="sort-icon"></span></th>
                                    <th data-column="quantidade" class="cursor-pointer">${quantidadeLabel} <span class="sort-icon"></span></th>
                                    <th data-column="valorUnitario" class="cursor-pointer">Valor Unitário (R$) <span class="sort-icon"></span></th>
                                    <th data-column="valorTotal" class="cursor-pointer">Valor Total (R$) <span class="sort-icon"></span></th>
                                    <th data-column="depreciacao" class="cursor-pointer">${depreciacaoLabel} <span class="sort-icon"></span></th>
                                    <th class="no-print">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3" class="text-right font-semibold">Total da Categoria:</td>
                                    <td data-total="valorTotal">${formatCurrency(0)}</td>
                                    <td data-total="depreciacao">${formatCurrency(0)}</td>
                                    <td class="no-print"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="mt-4 text-right no-print">
                        <button class="btn-add add-row-btn" data-category-id="${category.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                            </svg>
                            Adicionar Item
                        </button>
                    </div>
                </div>
            `;
            mainContainer.appendChild(categoryDiv);
            const tbody = categoryDiv.querySelector('tbody');
            if (category.items.length === 0) {
                 addRow(category.id, tbody); // Pass tbody to avoid re-querying
            } else {
                category.items.forEach(item => tbody.appendChild(renderRow(category.id, item)));
            }

            categoryDiv.querySelector('.add-row-btn').addEventListener('click', () => {
                addRow(category.id);
                saveToLocalStorage();
            });
            categoryDiv.querySelectorAll('th[data-column]').forEach(th => {
                th.addEventListener('click', () => sortTable(category.id, th.dataset.column, th));
            });
        }

        // Função para adicionar uma nova linha
        function addRow(categoryId, tbodyElement) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Criar novo item com valores padrão específicos para cada categoria
            let newItem;
            if (categoryId === 'equipe') {
                newItem = { id: createRowId(), item: '', quantidade: 0, valorUnitario: 0, encargos: 0 };
            } else if (categoryId === 'servicos') {
                newItem = { id: createRowId(), item: '', tempo: 0, valorUnitario: 0, depreciacao: 0, periodoTempo: 'MÊS' };
            } else {
                newItem = { id: createRowId(), item: '', quantidade: 0, valorUnitario: 0, depreciacao: 0, unidade: 'un' };
            }
            
            category.items.push(newItem);
            const tbody = tbodyElement || mainContainer.querySelector(`#category-${categoryId} table tbody`);
            tbody.appendChild(renderRow(categoryId, newItem));
            updateCalculations(categoryId, newItem.id); 
        }

        // Função para remover uma linha
        function removeRow(categoryId, rowId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            category.items = category.items.filter(item => item.id !== rowId);
            const rowElement = mainContainer.querySelector(`#category-${categoryId} tr[data-row-id="${rowId}"]`);
            if (rowElement) rowElement.remove();
            updateCategoryTotals(categoryId);
            updateGrandTotals();
        }

        // Função para atualizar cálculos de uma linha
        function updateCalculations(categoryId, rowId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            const item = category.items.find(i => i.id === rowId);
            if (!item) return;

            const rowElement = mainContainer.querySelector(`#category-${categoryId} tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;

            // Atualizar valores do item com base nos inputs
            item.item = rowElement.querySelector('.item-input').value;
            
            // Tratamento específico para cada categoria
            if (categoryId === 'equipe') {
                item.quantidade = parseCurrency(rowElement.querySelector('.quantidade-input').value);
                item.valorUnitario = parseCurrency(rowElement.querySelector('.valor-unitario-input').value);
                item.encargos = calcularEncargosSociais(item.valorUnitario);
                rowElement.querySelector('.encargos-input').value = item.encargos.toFixed(2);
            } else if (categoryId === 'servicos') {
                item.tempo = parseCurrency(rowElement.querySelector('.tempo-input').value);
                item.quantidade = item.tempo; // Manter compatibilidade
                item.valorUnitario = parseCurrency(rowElement.querySelector('.valor-unitario-input').value);
                item.depreciacao = parseCurrency(rowElement.querySelector('.depreciacao-input').value);
                item.periodoTempo = rowElement.querySelector('.periodo-tempo-select').value;
            } else {
                item.quantidade = parseCurrency(rowElement.querySelector('.quantidade-input').value);
                item.valorUnitario = parseCurrency(rowElement.querySelector('.valor-unitario-input').value);
                item.depreciacao = parseCurrency(rowElement.querySelector('.depreciacao-input').value);
                item.unidade = rowElement.querySelector('.unidade-select').value;
            }

            // Atualizar valor total na célula
            const valorTotal = item.quantidade * item.valorUnitario;
            rowElement.querySelector('.valor-total-cell').textContent = formatCurrency(valorTotal);

            updateCategoryTotals(categoryId);
            updateGrandTotals();
        }

        // Função para atualizar totais de uma categoria
        function updateCategoryTotals(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            let totalValorCategoria = 0;
            let totalDepreciacaoCategoria = 0;
            
            category.items.forEach(item => {
                totalValorCategoria += item.quantidade * item.valorUnitario;
                if (categoryId === 'equipe') {
                    totalDepreciacaoCategoria += item.encargos;
                } else {
                    totalDepreciacaoCategoria += item.depreciacao;
                }
            });
            
            const categoryTable = mainContainer.querySelector(`#category-${categoryId} table`);
            categoryTable.querySelector('tfoot td[data-total="valorTotal"]').textContent = formatCurrency(totalValorCategoria);
            categoryTable.querySelector('tfoot td[data-total="depreciacao"]').textContent = formatCurrency(totalDepreciacaoCategoria);
        }

        // Função para atualizar totais gerais
        function updateGrandTotals() {
            let grandTotalValor = 0;
            let grandTotalDepreciacao = 0;
            
            categories.forEach(category => {
                category.items.forEach(item => {
                    grandTotalValor += item.quantidade * item.valorUnitario;
                    if (category.id === 'equipe') {
                        grandTotalDepreciacao += item.encargos;
                    } else {
                        grandTotalDepreciacao += item.depreciacao;
                    }
                });
            });
            
            grandTotalValorEl.textContent = formatCurrency(grandTotalValor);
            grandTotalDepreciacaoEl.textContent = formatCurrency(grandTotalDepreciacao);
        }

        // Função para exportar para PDF
        function exportToPdf() {
            const elementToPrint = document.getElementById('planilhaCompleta');
            
            // Preparar elementos para impressão
            const inputs = elementToPrint.querySelectorAll('input[type="text"], input[type="number"]');
            const selects = elementToPrint.querySelectorAll('select');
            const tempSpans = [];

            // Substituir inputs por seus valores para impressão
            inputs.forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value;
                span.style.display = 'inline'; // Garantir que seja exibido
                input.style.display = 'none'; // Ocultar o campo de entrada
                input.parentNode.insertBefore(span, input.nextSibling);
                tempSpans.push({element: input, span});
            });
            
            // Substituir selects por seus valores para impressão
            selects.forEach(select => {
                const span = document.createElement('span');
                span.textContent = select.options[select.selectedIndex].text;
                span.style.display = 'inline';
                select.style.display = 'none';
                select.parentNode.insertBefore(span, select.nextSibling);
                tempSpans.push({element: select, span});
            });

            const opt = {
                margin: [0.5, 0.2, 0.5, 0.2],
                filename: 'planilha_estrutura_e_valores.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    logging: false, 
                    useCORS: true, 
                    letterRendering: true,
                    scrollY: 0,
                    width: elementToPrint.offsetWidth * 1.5, // Aumentar a largura para evitar cortes
                    height: elementToPrint.offsetHeight * 1.5 // Aumentar a altura para evitar cortes
                },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().from(elementToPrint).set(opt).save().then(() => {
                // Restaurar inputs e remover spans
                tempSpans.forEach(item => {
                    item.element.style.display = ''; // Mostrar input novamente
                    item.span.remove();
                });
            }).catch(err => {
                console.error("Erro ao exportar para PDF:", err);
                tempSpans.forEach(item => { // Garantir limpeza em caso de erro
                    item.element.style.display = '';
                    item.span.remove();
                });
            });
        }
        
        // Função para obter dados da tabela para Excel
        function getTableDataForExcel() {
            const allData = [];
            categories.forEach(category => {
                allData.push([category.name]);
                
                // Cabeçalhos específicos para cada categoria
                if (category.id === 'equipe') {
                    allData.push(['Item', 'Quantidade', 'Valor Unitário (R$)', 'Valor Total (R$)', 'Encargos Sociais (R$)']);
                } else if (category.id === 'servicos') {
                    allData.push(['Item', 'Tempo', 'Período', 'Valor Unitário (R$)', 'Valor Total (R$)', 'Depreciação (R$)']);
                } else {
                    allData.push(['Item', 'Quantidade', 'Unidade', 'Valor Unitário (R$)', 'Valor Total (R$)', 'Depreciação (R$)']);
                }
                
                // Dados de cada item
                category.items.forEach(item => {
                    if (category.id === 'equipe') {
                        allData.push([
                            item.item,
                            item.quantidade,
                            item.valorUnitario,
                            item.quantidade * item.valorUnitario,
                            item.encargos
                        ]);
                    } else if (category.id === 'servicos') {
                        allData.push([
                            item.item,
                            item.tempo || item.quantidade,
                            item.periodoTempo || 'MÊS',
                            item.valorUnitario,
                            (item.tempo || item.quantidade) * item.valorUnitario,
                            item.depreciacao
                        ]);
                    } else {
                        allData.push([
                            item.item,
                            item.quantidade,
                            item.unidade || 'un',
                            item.valorUnitario,
                            item.quantidade * item.valorUnitario,
                            item.depreciacao
                        ]);
                    }
                });
                
                // Totais da categoria
                let totalValorCategoria = 0, totalDepreciacaoCategoria = 0;
                category.items.forEach(item => {
                    totalValorCategoria += item.quantidade * item.valorUnitario;
                    if (category.id === 'equipe') {
                        totalDepreciacaoCategoria += item.encargos;
                    } else {
                        totalDepreciacaoCategoria += item.depreciacao;
                    }
                });
                
                if (category.id === 'equipe') {
                    allData.push(['', '', 'Total da Categoria:', totalValorCategoria, totalDepreciacaoCategoria]);
                } else if (category.id === 'servicos') {
                    allData.push(['', '', '', 'Total da Categoria:', totalValorCategoria, totalDepreciacaoCategoria]);
                } else {
                    allData.push(['', '', '', 'Total da Categoria:', totalValorCategoria, totalDepreciacaoCategoria]);
                }
                
                allData.push([]); 
            });
            
            // Totais gerais
            let grandTotalValor = 0, grandTotalDepreciacao = 0;
            categories.forEach(category => {
                category.items.forEach(item => {
                    grandTotalValor += item.quantidade * item.valorUnitario;
                    if (category.id === 'equipe') {
                        grandTotalDepreciacao += item.encargos;
                    } else {
                        grandTotalDepreciacao += item.depreciacao;
                    }
                });
            });
            
            allData.push([]);
            allData.push(['', '', 'Valor Total Geral:', grandTotalValor]);
            allData.push(['', '', 'Depreciação/Encargos Total Geral:', grandTotalDepreciacao]);
            
            return allData;
        }

        // Função para exportar para Excel
        function exportToExcel() {
            const data = getTableDataForExcel();
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const colWidths = [{wch:40}, {wch:15}, {wch:15}, {wch:20}, {wch:20}, {wch:20}];
            worksheet['!cols'] = colWidths;
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Planilha de Custos');
            XLSX.writeFile(workbook, 'planilha_estrutura_e_valores.xlsx');
        }

        // Função para limpar todos os dados
        function clearAllData() {
            if (!confirm("Tem certeza que deseja limpar todos os dados da planilha? Esta ação não pode ser desfeita.")) return;
            
            categories.forEach(category => {
                category.items = [];
                const tbody = mainContainer.querySelector(`#category-${category.id} table tbody`);
                tbody.innerHTML = '';
                addRow(category.id, tbody);
                updateCategoryTotals(category.id);
            });
            
            updateGrandTotals();
            document.getElementById('globalSearch').value = '';
            filterGlobalSearch();
            
            // Limpar localStorage
            localStorage.removeItem('planilhaCustos');
            showNotification('Todos os dados foram limpos');
        }

        // Estado de ordenação
        const sortState = {};
        
        // Função para ordenar tabela
        function sortTable(categoryId, column, thElement) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            const currentOrder = (sortState[categoryId] && sortState[categoryId].column === column) ? 
                (sortState[categoryId].order === 'asc' ? 'desc' : 'asc') : 'asc';
            
            sortState[categoryId] = { column, order: currentOrder };
            
            category.items.sort((a, b) => {
                let valA, valB;
                
                if (column === 'item') { 
                    valA = String(a.item).toLowerCase(); 
                    valB = String(b.item).toLowerCase(); 
                }
                else if (column === 'valorTotal') { 
                    valA = a.quantidade * a.valorUnitario; 
                    valB = b.quantidade * b.valorUnitario; 
                }
                else { 
                    valA = a[column]; 
                    valB = b[column]; 
                }
                
                if (valA < valB) return currentOrder === 'asc' ? -1 : 1;
                if (valA > valB) return currentOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            const tbody = mainContainer.querySelector(`#category-${categoryId} table tbody`);
            tbody.innerHTML = '';
            category.items.forEach(item => tbody.appendChild(renderRow(categoryId, item)));
            
            mainContainer.querySelectorAll(`#category-${categoryId} th .sort-icon`).forEach(icon => { 
                icon.className = 'sort-icon'; 
            });
            
            thElement.querySelector('.sort-icon').classList.add(currentOrder);
            filterGlobalSearch();
            saveToLocalStorage();
        }

        // Função para filtrar busca global
        function filterGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            
            categories.forEach(category => {
                const tbody = mainContainer.querySelector(`#category-${category.id} table tbody`);
                
                tbody.querySelectorAll('tr').forEach(row => {
                    const rowId = row.dataset.rowId;
                    const itemData = category.items.find(i => i.id === rowId);
                    
                    if (itemData) {
                        let itemText = `${itemData.item} ${itemData.quantidade} ${itemData.valorUnitario} ${itemData.quantidade * itemData.valorUnitario}`;
                        
                        if (category.id === 'equipe') {
                            itemText += ` ${itemData.encargos}`;
                        } else if (category.id === 'servicos') {
                            itemText += ` ${itemData.tempo || itemData.quantidade} ${itemData.periodoTempo || 'MÊS'} ${itemData.depreciacao}`;
                        } else {
                            itemText += ` ${itemData.unidade || 'un'} ${itemData.depreciacao}`;
                        }
                        
                        itemText = itemText.toLowerCase();
                        row.style.display = itemText.includes(searchTerm) ? '' : 'none';
                    }
                });
            });
        }

        // Funções para persistência de dados com localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('planilhaCustos', JSON.stringify(categories));
                // Não mostrar notificação a cada salvamento para não incomodar o usuário
            } catch (error) {
                console.error('Erro ao salvar dados no localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('planilhaCustos');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Atualizar categorias com dados salvos
                    parsedData.forEach((savedCategory, index) => {
                        if (index < categories.length) {
                            categories[index].items = savedCategory.items || [];
                        }
                    });
                    
                    showNotification('Dados carregados com sucesso');
                    return true;
                }
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
            }
            return false;
        }

        // Inicialização da aplicação
        mainContainer.innerHTML = ''; // Limpar placeholder
        
        // Tentar carregar dados do localStorage
        const dataLoaded = loadFromLocalStorage();
        
        // Renderizar categorias
        categories.forEach(renderCategory);
        
        // Atualizar totais gerais
        updateGrandTotals();

        // Event listeners
        document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        document.getElementById('globalSearch').addEventListener('input', filterGlobalSearch);

        // Salvar dados automaticamente a cada 30 segundos
        setInterval(saveToLocalStorage, 30000);
        
        // Salvar dados antes de fechar a página
        window.addEventListener('beforeunload', saveToLocalStorage);
    });
    </script>

</body>
</html>
