<!-- 
 ==============================================================================
 Author:       Victor S Caricatte De Ara√∫jo
 Email:        victorsc@ufmg.br
 Intitution:   Universidade federal de Minas Gerais
 Version:      1.3.4
 Date:         May,16
 ...................................
 ==============================================================================
-->

<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Estrutura e Valores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para exporta√ß√£o PDF e Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --color-bg-primary: #f3f4f6;
            --color-bg-secondary: #ffffff;
            --color-text-primary: #1f2937;
            --color-text-secondary: #4b5563;
            --color-border: #e5e7eb;
            --color-table-header: #f9fafb;
            --color-table-row-even: #f9fafb;
            --color-total-row-bg: #f0fdf4;
            --color-total-row-text: #15803d;
            --color-summary-bg: #e0f2fe;
            --color-summary-border: #bae6fd;
            --color-summary-title: #0c4a6e;
            --color-summary-text: #075985;
            --color-instructions-bg: #fffbeb;
            --color-instructions-border: #fef3c7;
            --color-instructions-text: #713f12;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-focus-border: #3b82f6;
            --color-focus-shadow: rgba(59, 130, 246, 0.15);
            --color-btn-add: #22c55e;
            --color-btn-add-hover: #16a34a;
            --color-btn-remove: #ef4444;
            --color-btn-remove-hover: #dc2626;
            --color-btn-pdf: #3b82f6;
            --color-btn-pdf-hover: #2563eb;
            --color-btn-excel: #10b981;
            --color-btn-excel-hover: #059669;
            --color-btn-clear: #f97316;
            --color-btn-clear-hover: #ea580c;
            --color-notification-bg: #10b981;
            --color-notification-text: white;
        }

        [data-theme="dark"] {
            --color-bg-primary: #1f2937;
            --color-bg-secondary: #374151;
            --color-text-primary: #f3f4f6;
            --color-text-secondary: #d1d5db;
            --color-border: #4b5563;
            --color-table-header: #111827;
            --color-table-row-even: #2d3748;
            --color-total-row-bg: #064e3b;
            --color-total-row-text: #a7f3d0;
            --color-summary-bg: #0c4a6e;
            --color-summary-border: #0369a1;
            --color-summary-title: #e0f2fe;
            --color-summary-text: #bae6fd;
            --color-instructions-bg: #78350f;
            --color-instructions-border: #92400e;
            --color-instructions-text: #fef3c7;
            --color-shadow: rgba(0, 0, 0, 0.5);
            --color-focus-border: #60a5fa;
            --color-focus-shadow: rgba(96, 165, 250, 0.25);
            --color-btn-add: #22c55e;
            --color-btn-add-hover: #16a34a;
            --color-btn-remove: #ef4444;
            --color-btn-remove-hover: #dc2626;
            --color-btn-pdf: #3b82f6;
            --color-btn-pdf-hover: #2563eb;
            --color-btn-excel: #10b981;
            --color-btn-excel-hover: #059669;
            --color-btn-clear: #f97316;
            --color-btn-clear-hover: #ea580c;
            --color-notification-bg: #10b981;
            --color-notification-text: white;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .table-container {
            background-color: var(--color-bg-secondary);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px var(--color-shadow), 0 2px 4px -1px var(--color-shadow);
            margin-bottom: 2rem;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .table-category {
            margin-bottom: 2rem;
        }
        .table-category h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0.5rem;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.875rem;
            transition: border-color 0.3s ease;
        }
        th {
            background-color: var(--color-table-header);
            font-weight: 600;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        th .sort-icon {
            margin-left: 0.25rem;
            opacity: 0.5;
        }
        th:hover .sort-icon {
            opacity: 1;
        }
        tr:nth-child(even) {
            background-color: var(--color-table-row-even);
            transition: background-color 0.3s ease;
        }
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
        }
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--color-focus-border);
            box-shadow: 0 0 0 3px var(--color-focus-shadow);
        }
        select {
            width: auto;
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            background-color: var(--color-bg-secondary);
            color: var(--color-text-primary);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background-color 0.3s ease, color 0.3s ease;
        }
        select:focus {
            outline: none;
            border-color: var(--color-focus-border);
            box-shadow: 0 0 0 3px var(--color-focus-shadow);
        }
        .total-row td {
            font-weight: 600;
            background-color: var(--color-total-row-bg);
            color: var(--color-total-row-text);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .action-buttons button, .global-actions button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .btn-add {
            background-color: transparent;
            color: var(--color-btn-add);
            border: none;
        }
        .btn-add:hover {
            color: var(--color-btn-add-hover);
            background-color: transparent;
        }
        .btn-remove {
            background-color: transparent;
            color: var(--color-btn-remove);
            padding: 0.3rem 0.6rem;
            border: none;
        }
        .btn-remove:hover {
            color: var(--color-btn-remove-hover);
            background-color: transparent;
        }
        .btn-export-pdf {
            background-color: var(--color-btn-pdf);
            color: white;
        }
        .btn-export-pdf:hover {
            background-color: var(--color-btn-pdf-hover);
        }
        .btn-export-excel {
            background-color: var(--color-btn-excel);
            color: white;
        }
        .btn-export-excel:hover {
            background-color: var(--color-btn-excel-hover);
        }
        .btn-clear {
            background-color: var(--color-btn-clear);
            color: white;
        }
        .btn-clear:hover {
            background-color: var(--color-btn-clear-hover);
        }
        .global-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--color-bg-secondary);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px var(--color-shadow), 0 2px 4px -1px var(--color-shadow);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .search-filter-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .search-filter-container input[type="text"] {
            min-width: 250px;
        }
        .totals-summary {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--color-summary-bg);
            border: 1px solid var(--color-summary-border);
            border-radius: 0.5rem;
            text-align: right;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .totals-summary h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--color-summary-title);
            transition: color 0.3s ease;
        }
        .totals-summary p {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: var(--color-summary-text);
            transition: color 0.3s ease;
        }
        .instructions {
            margin-top: 2rem;
            padding: 1rem;
            background-color: var(--color-instructions-bg);
            border: 1px solid var(--color-instructions-border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: var(--color-instructions-text);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .instructions h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .instructions ul {
            list-style-type: disc;
            margin-left: 1.5rem;
        }
        /* For sort icons */
        .sort-icon::after {
            content: '\2195';
            opacity: 0.5;
        }
        .sort-icon.asc::after {
            content: '\2191';
            opacity: 1;
        }
        .sort-icon.desc::after {
            content: '\2193';
            opacity: 1;
        }
        /* Hide elements meant only for PDF export from screen */
        .pdf-only {
            display: none;
        }
        /* Styles for PDF export - to be used by html2pdf.js if needed */
        @media print {
            body {
                font-family: 'Inter', sans-serif;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none !important;
            }
            .pdf-only {
                display: block !important;
            }
            .table-container, .global-actions, .totals-summary, .instructions {
                box-shadow: none;
                border: 1px solid #ccc;
                margin-bottom: 1rem;
            }
            table {
                font-size: 9pt;
                page-break-inside: avoid;
                width: 100%;
            }
            th, td {
                padding: 4pt 6pt;
            }
            input[type="text"], input[type="number"], select {
                 border: none;
                 padding: 2px;
                 background-color: transparent;
                 width: auto;
                 display: inline;
            }
            /* Attempt to show input values in PDF */
            input[type="text"]::after, input[type="number"]::after {
                 content: attr(value);
            }
        }
        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--color-notification-bg);
            color: var(--color-notification-text);
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .notification.show {
            opacity: 1;
        }
        /* Unidade de medida container */
        .unidade-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .unidade-container input {
            flex: 1;
        }
        .unidade-container select {
            width: auto;
            min-width: 70px;
        }
        /* Theme toggle switch */
        .theme-switch-container {
            display: flex;
            align-items: center;
            margin-left: 1rem;
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        .slider .icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            transition: .4s;
        }
        .slider .sun-icon {
            left: 8px;
            color: #f1c40f;
            opacity: 1;
        }
        .slider .moon-icon {
            right: 8px;
            color: #f1f1f1;
            opacity: 0;
        }
        input:checked + .slider .sun-icon {
            opacity: 0;
        }
        input:checked + .slider .moon-icon {
            opacity: 1;
        }
        /* Encargos sociais selector */
        .encargos-selector {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--color-bg-secondary);
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .encargos-selector h4 {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
            transition: color 0.3s ease;
        }
        .encargos-selector select {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .encargos-info {
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            margin-top: 0.5rem;
            transition: color 0.3s ease;
        }
    </style>
</head>
<body class="p-6 md:p-10">
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800">Planilha Estrutura e Valores</h1>
    </header>

    <div class="global-actions no-print">
        <div class="search-filter-container">
            <input type="text" id="globalSearch" placeholder="Buscar em todas as tabelas..." class="border-gray-300 focus:ring-blue-500 focus:border-blue-500">
            <div class="theme-switch-container">
                <label class="theme-switch">
                    <input type="checkbox" id="themeToggle">
                    <span class="slider">
                        <span class="icon sun-icon">‚òÄÔ∏è</span>
                        <span class="icon moon-icon">üåô</span>
                    </span>
                </label>
                <span class="ml-2 text-sm">Tema</span>
            </div>
        </div>
        <div>
            <button id="exportPdfBtn" class="btn-export-pdf">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-pdf-fill" viewBox="0 0 16 16">
                    <path d="M5.523 12.424c.14-.082.293-.162.459-.238a7.878 7.878 0 0 1-.45.606c-.28.337-.498.516-.635.572a.266.266 0 0 1-.035.012.282.282 0 0 1-.026-.044c-.056-.11-.054-.226.03-.335.078-.097.224-.24.401-.382z"/>
                    <path fill-rule="evenodd" d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2.5z"/>
                    <path d="M4.603 14.087a.81.81 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.68 7.68 0 0 1 1.482-.645 19.697 19.697 0 0 0 1.062-2.227 7.269 7.269 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.658-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.375-.038.563a.84.84 0 0 1-.23.518c-.203.226-.534.446-.92.624a5.48 5.48 0 0 0-1.305.794c-.057.035-.114.07-.17.107a1.06 1.06 0 0 0-.117.238.72.72 0 0 0 .03.285.64.64 0 0 0 .11.19c.097.1.248.193.436.26.19.07.407.11.614.09.142-.014.277-.05.39-.095a.1.1 0 0 1 .11.01.12.12 0 0 1 .01.111.12.12 0 0 1-.029.092c-.042.04-.12.06-.2.07a1.426 1.426 0 0 1-.47.03c-.283-.005-.599-.041-.909-.11a1.99 1.99 0 0 1-.908-.399z"/>
                </svg>
                Exportar para PDF
            </button>
            <button id="exportExcelBtn" class="btn-export-excel">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel-fill" viewBox="0 0 16 16">
                    <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM5.884 6.68 8 9.219l2.116-2.54a.5.5 0 1 1 .768.641L8.651 10l2.233 2.68a.5.5 0 0 1-.768.64L8 10.781l-2.116 2.54a.5.5 0 0 1-.768-.641L7.349 10 5.116 7.32a.5.5 0 1 1 .768-.64z"/>
                </svg>
                Exportar para Excel
            </button>
            <button id="clearDataBtn" class="btn-clear">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                    <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                </svg>
                Limpar Dados
            </button>
        </div>
    </div>

    <!-- Seletor de Encargos Sociais -->
    <div class="encargos-selector no-print">
        <h4>Configura√ß√£o de Encargos Sociais</h4>
        <select id="encargosSelector">
            <option value="simples_mensalista">Empresa Optante pelo SIMPLES - Sal√°rio Mensalista (32,82%)</option>
            <option value="simples_hora">Empresa Optante pelo SIMPLES - Sal√°rio/Hora (55,06%)</option>
            <option value="nao_simples_mensalista">Empresa N√ÉO Optante pelo SIMPLES - Sal√°rio Mensalista (67,22%)</option>
            <option value="nao_simples_hora">Empresa N√ÉO Optante pelo SIMPLES - Sal√°rio/Hora (89,46%)</option>
            <option value="personalizado">Personalizado</option>
        </select>
        <div id="encargosDetalhados" style="display: none;">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                <div>
                    <h5 class="font-semibold mb-1">Encargos Trabalhistas</h5>
                    <div class="flex items-center mb-1">
                        <label class="w-40">13¬∫ Sal√°rio:</label>
                        <input type="number" id="enc13Salario" min="0" max="100" step="0.01" value="8.33" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">F√©rias:</label>
                        <input type="number" id="encFerias" min="0" max="100" step="0.01" value="11.11" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">DSR:</label>
                        <input type="number" id="encDSR" min="0" max="100" step="0.01" value="0" class="w-20"> %
                    </div>
                </div>
                <div>
                    <h5 class="font-semibold mb-1">Encargos Sociais</h5>
                    <div class="flex items-center mb-1">
                        <label class="w-40">INSS:</label>
                        <input type="number" id="encINSS" min="0" max="100" step="0.01" value="0" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">SAT/RAT:</label>
                        <input type="number" id="encSAT" min="0" max="100" step="0.01" value="0" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">Sal√°rio Educa√ß√£o:</label>
                        <input type="number" id="encSalarioEducacao" min="0" max="100" step="0.01" value="0" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">INCRA/SEST/SEBRAE:</label>
                        <input type="number" id="encOutros" min="0" max="100" step="0.01" value="0" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">FGTS:</label>
                        <input type="number" id="encFGTS" min="0" max="100" step="0.01" value="8" class="w-20"> %
                    </div>
                    <div class="flex items-center mb-1">
                        <label class="w-40">FGTS/Multa Rescis√£o:</label>
                        <input type="number" id="encFGTSMulta" min="0" max="100" step="0.01" value="3.2" class="w-20"> %
                    </div>
                </div>
            </div>
        </div>
        <div class="encargos-info">
            Percentuais baseados nas tabelas do <a href="https://www.guiatrabalhista.com.br/tematicas/custostrabalhistas.htm" target="_blank" class="text-blue-500 hover:underline">Guia Trabalhista</a>
        </div>
    </div>

    <main id="planilhaCompleta">
        <!-- Categories will be dynamically generated or hardcoded here -->
        <!-- Example for one category -->
        <div class="table-container" id="category-infraestrutura">
            <div class="table-category">
                <h2>Infraestrutura</h2>
                <div class="overflow-x-auto">
                    <table data-category-id="infraestrutura">
                        <thead>
                            <tr>
                                <th data-column="item">Item <span class="sort-icon"></span></th>
                                <th data-column="quantidade">Quantidade <span class="sort-icon"></span></th>
                                <th data-column="valorUnitario">Valor Unit√°rio (R$) <span class="sort-icon"></span></th>
                                <th data-column="valorTotal">Valor Total (R$) <span class="sort-icon"></span></th>
                                <th data-column="depreciacao">Deprecia√ß√£o (R$) <span class="sort-icon"></span></th>
                                <th class="no-print">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be added here by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="3" class="text-right font-semibold">Total da Categoria:</td>
                                <td data-total="valorTotal">R$ 0,00</td>
                                <td data-total="depreciacao">R$ 0,00</td>
                                <td class="no-print"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="mt-4 text-right no-print">
                    <button class="btn-add add-row-btn" data-category-id="infraestrutura">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                        </svg>
                        Adicionar Item
                    </button>
                </div>
            </div>
        </div>

        <!-- Other categories will follow the same structure -->

    </main>

    <div class="totals-summary">
        <h3>Resumo Geral da Planilha</h3>
        <p>Valor Total Geral: <span id="grandTotalValor">R$ 0,00</span></p>
        <p>Deprecia√ß√£o Total Geral: <span id="grandTotalDepreciacao">R$ 0,00</span></p>
    </div>

    <div class="instructions no-print">
        <h4>Instru√ß√µes de Uso:</h4>
        <ul>
            <li>Clique em "Adicionar Item" para incluir novas linhas em cada categoria.</li>
            <li>Preencha os campos "Item", "Quantidade", "Valor Unit√°rio" e "Deprecia√ß√£o". O "Valor Total" √© calculado automaticamente.</li>
            <li>Selecione a unidade de medida apropriada para cada item (KG, G, MM, M, etc.).</li>
            <li>Na aba "Equipe", o campo "Encargos Sociais" √© calculado automaticamente com base no sal√°rio e na configura√ß√£o de encargos selecionada.</li>
            <li>Na aba "Servi√ßos", informe o tempo em meses ou anos conforme necess√°rio.</li>
            <li>Clique nos cabe√ßalhos das colunas para ordenar os dados.</li>
            <li>Utilize o campo "Buscar" para filtrar itens em todas as tabelas.</li>
            <li>Para remover um item, clique no √≠cone de lixeira (<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-trash3-fill inline" viewBox="0 0 16 16"><path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/></svg>) na linha correspondente.</li>
            <li>Exporte a planilha completa para PDF ou Excel utilizando os bot√µes no topo.</li>
            <li>"Limpar Dados" remover√° todas as informa√ß√µes inseridas (use com cuidado!).</li>
            <li>Os dados s√£o salvos automaticamente no navegador. N√£o ser√£o perdidos ao recarregar a p√°gina.</li>
            <li>Use o seletor de tema para alternar entre modo claro e escuro conforme sua prefer√™ncia.</li>
            <li>Configure os encargos sociais de acordo com o regime tribut√°rio da sua empresa.</li>
        </ul>
    </div>

    <!-- Notification element -->
    <div id="notification" class="notification">Dados salvos com sucesso!</div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Defini√ß√£o das categorias
        const categories = [
            { id: 'infraestrutura', name: 'Infraestrutura', items: [] },
            { id: 'equipamentos', name: 'Equipamentos e Utens√≠lios', items: [] },
            { id: 'equipe', name: 'Equipe', items: [] },
            { id: 'custos', name: 'Custos', items: [] },
            { id: 'servicos', name: 'Servi√ßos', items: [] },
            { id: 'insumos', name: 'Insumos e Materiais de Consumo', items: [] }
        ];

        const mainContainer = document.getElementById('planilhaCompleta');
        const grandTotalValorEl = document.getElementById('grandTotalValor');
        const grandTotalDepreciacaoEl = document.getElementById('grandTotalDepreciacao');
        const notification = document.getElementById('notification');
        const themeToggle = document.getElementById('themeToggle');
        const encargosSelector = document.getElementById('encargosSelector');
        const encargosDetalhados = document.getElementById('encargosDetalhados');

        // Configura√ß√µes de encargos sociais
        const encargosConfig = {
            simples_mensalista: {
                enc13Salario: 8.33,
                encFerias: 11.11,
                encDSR: 0,
                encINSS: 0,
                encSAT: 0,
                encSalarioEducacao: 0,
                encOutros: 0,
                encFGTS: 8,
                encFGTSMulta: 3.2
            },
            simples_hora: {
                enc13Salario: 8.33,
                encFerias: 11.11,
                encDSR: 20,
                encINSS: 0,
                encSAT: 0,
                encSalarioEducacao: 0,
                encOutros: 0,
                encFGTS: 8,
                encFGTSMulta: 3.2
            },
            nao_simples_mensalista: {
                enc13Salario: 8.33,
                encFerias: 11.11,
                encDSR: 0,
                encINSS: 20,
                encSAT: 3,
                encSalarioEducacao: 2.5,
                encOutros: 3.3,
                encFGTS: 8,
                encFGTSMulta: 3.2
            },
            nao_simples_hora: {
                enc13Salario: 8.33,
                encFerias: 11.11,
                encDSR: 20,
                encINSS: 20,
                encSAT: 3,
                encSalarioEducacao: 2.5,
                encOutros: 3.3,
                encFGTS: 8,
                encFGTSMulta: 3.2
            },
            personalizado: {
                enc13Salario: 8.33,
                encFerias: 11.11,
                encDSR: 0,
                encINSS: 0,
                encSAT: 0,
                encSalarioEducacao: 0,
                encOutros: 0,
                encFGTS: 8,
                encFGTSMulta: 3.2
            }
        };

        // Unidades de medida dispon√≠veis
        const unidadesMedida = [
            'un', 'KG', 'g', 'mg', 'L', 'mL', 'm', 'cm', 'mm', 'km', 'm¬≤', 'ha', 'm¬≥', 'T'
        ];

        // Fun√ß√£o para mostrar notifica√ß√£o
        function showNotification(message) {
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Fun√ß√£o para formatar valores monet√°rios
        function formatCurrency(value) {
            return `R$ ${parseFloat(value).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Fun√ß√£o para converter string de moeda para n√∫mero
        function parseCurrency(value) {
            if (typeof value === 'string') {
                return parseFloat(value.replace(/[^\d,.-]/g, '').replace('.', '').replace(',', '.')) || 0;
            }
            return parseFloat(value) || 0;
        }

        // Fun√ß√£o para criar ID √∫nico para cada linha
        function createRowId() {
            return `row-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }

        // Fun√ß√£o para calcular encargos sociais com base na configura√ß√£o selecionada
        function calcularEncargosSociais(salario) {
            const tipoEncargo = encargosSelector.value;
            let percentualTotal = 0;
            
            if (tipoEncargo === 'personalizado') {
                // Usar valores personalizados dos inputs
                percentualTotal += parseFloat(document.getElementById('encINSS').value || 0);
                percentualTotal += parseFloat(document.getElementById('encSAT').value || 0);
                percentualTotal += parseFloat(document.getElementById('encSalarioEducacao').value || 0);
                percentualTotal += parseFloat(document.getElementById('encOutros').value || 0);
                percentualTotal += parseFloat(document.getElementById('encFGTS').value || 0);
                percentualTotal += parseFloat(document.getElementById('encFGTSMulta').value || 0);
            } else {
                // Usar valores predefinidos
                const config = encargosConfig[tipoEncargo];
                percentualTotal += config.encINSS;
                percentualTotal += config.encSAT;
                percentualTotal += config.encSalarioEducacao;
                percentualTotal += config.encOutros;
                percentualTotal += config.encFGTS;
                percentualTotal += config.encFGTSMulta;
            }
            
            return salario * (percentualTotal / 100);
        }

        // Fun√ß√£o para renderizar uma linha de tabela
        function renderRow(categoryId, item = { id: createRowId(), item: '', quantidade: 0, valorUnitario: 0, depreciacao: 0, unidade: 'un', encargos: 0, tempo: 0, periodoTempo: 'M√äS' }) {
            const tr = document.createElement('tr');
            tr.setAttribute('data-row-id', item.id);
            
            // Verificar se √© a categoria "equipe" para mostrar encargos sociais em vez de deprecia√ß√£o
            if (categoryId === 'equipe') {
                tr.innerHTML = `
                    <td><input type="text" class="item-input w-full p-1 border rounded" value="${item.item}" placeholder="Nome do funcion√°rio"></td>
                    <td><input type="number" class="quantidade-input w-full p-1 border rounded" value="${item.quantidade}" min="0" step="any" placeholder="Quantidade"></td>
                    <td><input type="number" class="valor-unitario-input w-full p-1 border rounded" value="${item.valorUnitario}" min="0" step="0.01" placeholder="Sal√°rio"></td>
                    <td class="valor-total-cell">${formatCurrency(item.quantidade * item.valorUnitario)}</td>
                    <td><input type="number" class="encargos-input w-full p-1 border rounded" value="${item.encargos || calcularEncargosSociais(item.valorUnitario)}" min="0" step="0.01" readonly></td>
                    <td class="no-print"><button class="btn-remove remove-row-btn" data-category-id="${categoryId}" data-row-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                        </svg>
                    </button></td>
                `;
            } 
            // Verificar se √© a categoria "servicos" para mostrar tempo em vez de quantidade
            else if (categoryId === 'servicos') {
                tr.innerHTML = `
                    <td><input type="text" class="item-input w-full p-1 border rounded" value="${item.item}" placeholder="Nome do servi√ßo"></td>
                    <td class="unidade-container">
                        <input type="number" class="tempo-input w-full p-1 border rounded" value="${item.tempo || item.quantidade}" min="0" step="any" placeholder="Tempo">
                        <select class="periodo-tempo-select p-1 border rounded">
                            <option value="M√äS" ${(item.periodoTempo || 'M√äS') === 'M√äS' ? 'selected' : ''}>M√äS</option>
                            <option value="ANO" ${(item.periodoTempo || 'M√äS') === 'ANO' ? 'selected' : ''}>ANO</option>
                        </select>
                    </td>
                    <td><input type="number" class="valor-unitario-input w-full p-1 border rounded" value="${item.valorUnitario}" min="0" step="0.01" placeholder="Valor por per√≠odo"></td>
                    <td class="valor-total-cell">${formatCurrency((item.tempo || item.quantidade) * item.valorUnitario)}</td>
                    <td><input type="number" class="depreciacao-input w-full p-1 border rounded" value="${item.depreciacao}" min="0" step="0.01" placeholder="Deprecia√ß√£o"></td>
                    <td class="no-print"><button class="btn-remove remove-row-btn" data-category-id="${categoryId}" data-row-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                        </svg>
                    </button></td>
                `;
            }
            // Para as demais categorias
            else {
                tr.innerHTML = `
                    <td><input type="text" class="item-input w-full p-1 border rounded" value="${item.item}" placeholder="Nome do item"></td>
                    <td class="unidade-container">
                        <input type="number" class="quantidade-input w-full p-1 border rounded" value="${item.quantidade}" min="0" step="any" placeholder="Quantidade">
                        <select class="unidade-select p-1 border rounded">
                            ${unidadesMedida.map(un => `<option value="${un}" ${(item.unidade || 'un') === un ? 'selected' : ''}>${un}</option>`).join('')}
                        </select>
                    </td>
                    <td><input type="number" class="valor-unitario-input w-full p-1 border rounded" value="${item.valorUnitario}" min="0" step="0.01" placeholder="Valor unit√°rio"></td>
                    <td class="valor-total-cell">${formatCurrency(item.quantidade * item.valorUnitario)}</td>
                    <td><input type="number" class="depreciacao-input w-full p-1 border rounded" value="${item.depreciacao}" min="0" step="0.01" placeholder="Deprecia√ß√£o"></td>
                    <td class="no-print"><button class="btn-remove remove-row-btn" data-category-id="${categoryId}" data-row-id="${item.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3-fill" viewBox="0 0 16 16">
                            <path d="M11 1.5v1h3.5a.5.5 0 0 1 0 1h-.538l-.853 10.66A2 2 0 0 1 11.115 16h-6.23a2 2 0 0 1-1.994-1.84L2.038 3.5H1.5a.5.5 0 0 1 0-1H5v-1A1.5 1.5 0 0 1 6.5 0h3A1.5 1.5 0 0 1 11 1.5Zm-5 0v1h4v-1a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5ZM4.5 5.029l.5 8.5a.5.5 0 1 0 .998-.06l-.5-8.5a.5.5 0 1 0-.998.06Zm6.53-.528a.5.5 0 0 0-.528.47l-.5 8.5a.5.5 0 0 0 .998.058l.5-8.5a.5.5 0 0 0-.47-.528ZM8 4.5a.5.5 0 0 0-.5.5v8.5a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5Z"/>
                        </svg>
                    </button></td>
                `;
            }

            // Adicionar event listeners para inputs
            tr.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => {
                    updateCalculations(categoryId, item.id);
                    saveToLocalStorage();
                });
                input.addEventListener('change', () => {
                    updateCalculations(categoryId, item.id);
                    saveToLocalStorage();
                });
            });
            
            // Event listener para bot√£o de remover
            tr.querySelector('.remove-row-btn').addEventListener('click', () => {
                removeRow(categoryId, item.id);
                saveToLocalStorage();
            });
            
            return tr;
        }

        // Fun√ß√£o para renderizar uma categoria
        function renderCategory(category) {
            // Verificar se √© a categoria "equipe" para mostrar encargos sociais em vez de deprecia√ß√£o
            const depreciacaoLabel = category.id === 'equipe' ? 'Encargos Sociais (R$)' : 'Deprecia√ß√£o (R$)';
            // Verificar se √© a categoria "servicos" para mostrar tempo em vez de quantidade
            const quantidadeLabel = category.id === 'servicos' ? 'Tempo' : 'Quantidade';
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'table-container';
            categoryDiv.id = `category-${category.id}`;
            categoryDiv.innerHTML = `
                <div class="table-category">
                    <h2>${category.name}</h2>
                    <div class="overflow-x-auto">
                        <table data-category-id="${category.id}" class="w-full">
                            <thead>
                                <tr>
                                    <th data-column="item" class="cursor-pointer">Item <span class="sort-icon"></span></th>
                                    <th data-column="quantidade" class="cursor-pointer">${quantidadeLabel} <span class="sort-icon"></span></th>
                                    <th data-column="valorUnitario" class="cursor-pointer">Valor Unit√°rio (R$) <span class="sort-icon"></span></th>
                                    <th data-column="valorTotal" class="cursor-pointer">Valor Total (R$) <span class="sort-icon"></span></th>
                                    <th data-column="depreciacao" class="cursor-pointer">${depreciacaoLabel} <span class="sort-icon"></span></th>
                                    <th class="no-print">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td colspan="3" class="text-right font-semibold">Total da Categoria:</td>
                                    <td data-total="valorTotal">${formatCurrency(0)}</td>
                                    <td data-total="depreciacao">${formatCurrency(0)}</td>
                                    <td class="no-print"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="mt-4 text-right no-print">
                        <button class="btn-add add-row-btn" data-category-id="${category.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle-fill" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/>
                            </svg>
                            Adicionar Item
                        </button>
                    </div>
                </div>
            `;
            mainContainer.appendChild(categoryDiv);
            const tbody = categoryDiv.querySelector('tbody');
            if (category.items.length === 0) {
                 addRow(category.id, tbody); // Pass tbody to avoid re-querying
            } else {
                category.items.forEach(item => tbody.appendChild(renderRow(category.id, item)));
            }

            categoryDiv.querySelector('.add-row-btn').addEventListener('click', () => {
                addRow(category.id);
                saveToLocalStorage();
            });
            categoryDiv.querySelectorAll('th[data-column]').forEach(th => {
                th.addEventListener('click', () => sortTable(category.id, th.dataset.column, th));
            });
        }

        // Fun√ß√£o para adicionar uma nova linha
        function addRow(categoryId, tbodyElement) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            // Criar novo item com valores padr√£o espec√≠ficos para cada categoria
            let newItem;
            if (categoryId === 'equipe') {
                newItem = { id: createRowId(), item: '', quantidade: 0, valorUnitario: 0, encargos: 0 };
            } else if (categoryId === 'servicos') {
                newItem = { id: createRowId(), item: '', tempo: 0, valorUnitario: 0, depreciacao: 0, periodoTempo: 'M√äS' };
            } else {
                newItem = { id: createRowId(), item: '', quantidade: 0, valorUnitario: 0, depreciacao: 0, unidade: 'un' };
            }
            
            category.items.push(newItem);
            const tbody = tbodyElement || mainContainer.querySelector(`#category-${categoryId} table tbody`);
            tbody.appendChild(renderRow(categoryId, newItem));
            updateCalculations(categoryId, newItem.id); 
        }

        // Fun√ß√£o para remover uma linha
        function removeRow(categoryId, rowId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            category.items = category.items.filter(item => item.id !== rowId);
            const rowElement = mainContainer.querySelector(`#category-${categoryId} tr[data-row-id="${rowId}"]`);
            if (rowElement) rowElement.remove();
            updateCategoryTotals(categoryId);
            updateGrandTotals();
        }

        // Fun√ß√£o para atualizar c√°lculos de uma linha
        function updateCalculations(categoryId, rowId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            const item = category.items.find(i => i.id === rowId);
            if (!item) return;

            const rowElement = mainContainer.querySelector(`#category-${categoryId} tr[data-row-id="${rowId}"]`);
            if (!rowElement) return;

            // Atualizar valores do item com base nos inputs
            item.item = rowElement.querySelector('.item-input').value;
            
            // Tratamento espec√≠fico para cada categoria
            if (categoryId === 'equipe') {
                item.quantidade = parseCurrency(rowElement.querySelector('.quantidade-input').value);
                item.valorUnitario = parseCurrency(rowElement.querySelector('.valor-unitario-input').value);
                item.encargos = calcularEncargosSociais(item.valorUnitario);
                rowElement.querySelector('.encargos-input').value = item.encargos.toFixed(2);
            } else if (categoryId === 'servicos') {
                item.tempo = parseCurrency(rowElement.querySelector('.tempo-input').value);
                item.quantidade = item.tempo; // Manter compatibilidade
                item.valorUnitario = parseCurrency(rowElement.querySelector('.valor-unitario-input').value);
                item.depreciacao = parseCurrency(rowElement.querySelector('.depreciacao-input').value);
                item.periodoTempo = rowElement.querySelector('.periodo-tempo-select').value;
            } else {
                item.quantidade = parseCurrency(rowElement.querySelector('.quantidade-input').value);
                item.valorUnitario = parseCurrency(rowElement.querySelector('.valor-unitario-input').value);
                item.depreciacao = parseCurrency(rowElement.querySelector('.depreciacao-input').value);
                item.unidade = rowElement.querySelector('.unidade-select').value;
            }

            // Atualizar valor total na c√©lula
            const valorTotal = item.quantidade * item.valorUnitario;
            rowElement.querySelector('.valor-total-cell').textContent = formatCurrency(valorTotal);

            updateCategoryTotals(categoryId);
            updateGrandTotals();
        }

        // Fun√ß√£o para atualizar totais de uma categoria
        function updateCategoryTotals(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            let totalValorCategoria = 0;
            let totalDepreciacaoCategoria = 0;
            
            category.items.forEach(item => {
                totalValorCategoria += item.quantidade * item.valorUnitario;
                if (categoryId === 'equipe') {
                    totalDepreciacaoCategoria += item.encargos;
                } else {
                    totalDepreciacaoCategoria += item.depreciacao;
                }
            });
            
            const categoryTable = mainContainer.querySelector(`#category-${categoryId} table`);
            categoryTable.querySelector('tfoot td[data-total="valorTotal"]').textContent = formatCurrency(totalValorCategoria);
            categoryTable.querySelector('tfoot td[data-total="depreciacao"]').textContent = formatCurrency(totalDepreciacaoCategoria);
        }

        // Fun√ß√£o para atualizar totais gerais
        function updateGrandTotals() {
            let grandTotalValor = 0;
            let grandTotalDepreciacao = 0;
            
            categories.forEach(category => {
                category.items.forEach(item => {
                    grandTotalValor += item.quantidade * item.valorUnitario;
                    if (category.id === 'equipe') {
                        grandTotalDepreciacao += item.encargos;
                    } else {
                        grandTotalDepreciacao += item.depreciacao;
                    }
                });
            });
            
            grandTotalValorEl.textContent = formatCurrency(grandTotalValor);
            grandTotalDepreciacaoEl.textContent = formatCurrency(grandTotalDepreciacao);
        }

        // Fun√ß√£o para atualizar encargos sociais em todas as linhas da categoria equipe
        function updateAllEncargosSociais() {
            const equipeCategory = categories.find(c => c.id === 'equipe');
            if (!equipeCategory) return;
            
            equipeCategory.items.forEach(item => {
                item.encargos = calcularEncargosSociais(item.valorUnitario);
                const rowElement = mainContainer.querySelector(`#category-equipe tr[data-row-id="${item.id}"]`);
                if (rowElement) {
                    rowElement.querySelector('.encargos-input').value = item.encargos.toFixed(2);
                }
            });
            
            updateCategoryTotals('equipe');
            updateGrandTotals();
            saveToLocalStorage();
        }

        // Fun√ß√£o para exportar para PDF
        function exportToPdf() {
            const elementToPrint = document.getElementById('planilhaCompleta');
            
            // Preparar elementos para impress√£o
            const inputs = elementToPrint.querySelectorAll('input[type="text"], input[type="number"]');
            const selects = elementToPrint.querySelectorAll('select');
            const tempSpans = [];

            // Substituir inputs por seus valores para impress√£o
            inputs.forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value;
                span.style.display = 'inline'; // Garantir que seja exibido
                input.style.display = 'none'; // Ocultar o campo de entrada
                input.parentNode.insertBefore(span, input.nextSibling);
                tempSpans.push({element: input, span});
            });
            
            // Substituir selects por seus valores para impress√£o
            selects.forEach(select => {
                const span = document.createElement('span');
                span.textContent = select.options[select.selectedIndex].text;
                span.style.display = 'inline';
                select.style.display = 'none';
                select.parentNode.insertBefore(span, select.nextSibling);
                tempSpans.push({element: select, span});
            });

            const opt = {
                margin: [0.5, 0.2, 0.5, 0.2],
                filename: 'planilha_estrutura_e_valores.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    logging: false, 
                    useCORS: true, 
                    letterRendering: true,
                    scrollY: 0,
                    width: elementToPrint.offsetWidth * 1.5, // Aumentar a largura para evitar cortes
                    height: elementToPrint.offsetHeight * 1.5 // Aumentar a altura para evitar cortes
                },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().from(elementToPrint).set(opt).save().then(() => {
                // Restaurar inputs e remover spans
                tempSpans.forEach(item => {
                    item.element.style.display = ''; // Mostrar input novamente
                    item.span.remove();
                });
            }).catch(err => {
                console.error("Erro ao exportar para PDF:", err);
                tempSpans.forEach(item => { // Garantir limpeza em caso de erro
                    item.element.style.display = '';
                    item.span.remove();
                });
            });
        }
        
        // Fun√ß√£o para obter dados da tabela para Excel
        function getTableDataForExcel() {
            const allData = [];
            categories.forEach(category => {
                allData.push([category.name]);
                
                // Cabe√ßalhos espec√≠ficos para cada categoria
                if (category.id === 'equipe') {
                    allData.push(['Item', 'Quantidade', 'Valor Unit√°rio (R$)', 'Valor Total (R$)', 'Encargos Sociais (R$)']);
                } else if (category.id === 'servicos') {
                    allData.push(['Item', 'Tempo', 'Per√≠odo', 'Valor Unit√°rio (R$)', 'Valor Total (R$)', 'Deprecia√ß√£o (R$)']);
                } else {
                    allData.push(['Item', 'Quantidade', 'Unidade', 'Valor Unit√°rio (R$)', 'Valor Total (R$)', 'Deprecia√ß√£o (R$)']);
                }
                
                // Dados de cada item
                category.items.forEach(item => {
                    if (category.id === 'equipe') {
                        allData.push([
                            item.item,
                            item.quantidade,
                            item.valorUnitario,
                            item.quantidade * item.valorUnitario,
                            item.encargos
                        ]);
                    } else if (category.id === 'servicos') {
                        allData.push([
                            item.item,
                            item.tempo || item.quantidade,
                            item.periodoTempo || 'M√äS',
                            item.valorUnitario,
                            (item.tempo || item.quantidade) * item.valorUnitario,
                            item.depreciacao
                        ]);
                    } else {
                        allData.push([
                            item.item,
                            item.quantidade,
                            item.unidade || 'un',
                            item.valorUnitario,
                            item.quantidade * item.valorUnitario,
                            item.depreciacao
                        ]);
                    }
                });
                
                // Totais da categoria
                let totalValorCategoria = 0, totalDepreciacaoCategoria = 0;
                category.items.forEach(item => {
                    totalValorCategoria += item.quantidade * item.valorUnitario;
                    if (category.id === 'equipe') {
                        totalDepreciacaoCategoria += item.encargos;
                    } else {
                        totalDepreciacaoCategoria += item.depreciacao;
                    }
                });
                
                if (category.id === 'equipe') {
                    allData.push(['', '', 'Total da Categoria:', totalValorCategoria, totalDepreciacaoCategoria]);
                } else if (category.id === 'servicos') {
                    allData.push(['', '', '', 'Total da Categoria:', totalValorCategoria, totalDepreciacaoCategoria]);
                } else {
                    allData.push(['', '', '', 'Total da Categoria:', totalValorCategoria, totalDepreciacaoCategoria]);
                }
                
                allData.push([]); 
            });
            
            // Totais gerais
            let grandTotalValor = 0, grandTotalDepreciacao = 0;
            categories.forEach(category => {
                category.items.forEach(item => {
                    grandTotalValor += item.quantidade * item.valorUnitario;
                    if (category.id === 'equipe') {
                        grandTotalDepreciacao += item.encargos;
                    } else {
                        grandTotalDepreciacao += item.depreciacao;
                    }
                });
            });
            
            allData.push([]);
            allData.push(['', '', 'Valor Total Geral:', grandTotalValor]);
            allData.push(['', '', 'Deprecia√ß√£o/Encargos Total Geral:', grandTotalDepreciacao]);
            
            return allData;
        }

        // Fun√ß√£o para exportar para Excel
        function exportToExcel() {
            const data = getTableDataForExcel();
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const colWidths = [{wch:40}, {wch:15}, {wch:15}, {wch:20}, {wch:20}, {wch:20}];
            worksheet['!cols'] = colWidths;
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Planilha de Custos');
            XLSX.writeFile(workbook, 'planilha_estrutura_e_valores.xlsx');
        }

        // Fun√ß√£o para limpar todos os dados
        function clearAllData() {
            if (!confirm("Tem certeza que deseja limpar todos os dados da planilha? Esta a√ß√£o n√£o pode ser desfeita.")) return;
            
            categories.forEach(category => {
                category.items = [];
                const tbody = mainContainer.querySelector(`#category-${category.id} table tbody`);
                tbody.innerHTML = '';
                addRow(category.id, tbody);
                updateCategoryTotals(category.id);
            });
            
            updateGrandTotals();
            document.getElementById('globalSearch').value = '';
            filterGlobalSearch();
            
            // Limpar localStorage
            localStorage.removeItem('planilhaCustos');
            localStorage.removeItem('planilhaConfig');
            showNotification('Todos os dados foram limpos');
        }

        // Estado de ordena√ß√£o
        const sortState = {};
        
        // Fun√ß√£o para ordenar tabela
        function sortTable(categoryId, column, thElement) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            const currentOrder = (sortState[categoryId] && sortState[categoryId].column === column) ? 
                (sortState[categoryId].order === 'asc' ? 'desc' : 'asc') : 'asc';
            
            sortState[categoryId] = { column, order: currentOrder };
            
            category.items.sort((a, b) => {
                let valA, valB;
                
                if (column === 'item') { 
                    valA = String(a.item).toLowerCase(); 
                    valB = String(b.item).toLowerCase(); 
                }
                else if (column === 'valorTotal') { 
                    valA = a.quantidade * a.valorUnitario; 
                    valB = b.quantidade * b.valorUnitario; 
                }
                else { 
                    valA = a[column]; 
                    valB = b[column]; 
                }
                
                if (valA < valB) return currentOrder === 'asc' ? -1 : 1;
                if (valA > valB) return currentOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            const tbody = mainContainer.querySelector(`#category-${categoryId} table tbody`);
            tbody.innerHTML = '';
            category.items.forEach(item => tbody.appendChild(renderRow(categoryId, item)));
            
            mainContainer.querySelectorAll(`#category-${categoryId} th .sort-icon`).forEach(icon => { 
                icon.className = 'sort-icon'; 
            });
            
            thElement.querySelector('.sort-icon').classList.add(currentOrder);
            filterGlobalSearch();
            saveToLocalStorage();
        }

        // Fun√ß√£o para filtrar busca global
        function filterGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase();
            
            categories.forEach(category => {
                const tbody = mainContainer.querySelector(`#category-${category.id} table tbody`);
                
                tbody.querySelectorAll('tr').forEach(row => {
                    const rowId = row.dataset.rowId;
                    const itemData = category.items.find(i => i.id === rowId);
                    
                    if (itemData) {
                        let itemText = `${itemData.item} ${itemData.quantidade} ${itemData.valorUnitario} ${itemData.quantidade * itemData.valorUnitario}`;
                        
                        if (category.id === 'equipe') {
                            itemText += ` ${itemData.encargos}`;
                        } else if (category.id === 'servicos') {
                            itemText += ` ${itemData.tempo || itemData.quantidade} ${itemData.periodoTempo || 'M√äS'} ${itemData.depreciacao}`;
                        } else {
                            itemText += ` ${itemData.unidade || 'un'} ${itemData.depreciacao}`;
                        }
                        
                        itemText = itemText.toLowerCase();
                        row.style.display = itemText.includes(searchTerm) ? '' : 'none';
                    }
                });
            });
        }

        // Fun√ß√µes para persist√™ncia de dados com localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('planilhaCustos', JSON.stringify(categories));
                
                // Salvar configura√ß√µes adicionais
                const config = {
                    theme: document.documentElement.getAttribute('data-theme') || 'light',
                    encargosType: encargosSelector.value,
                    encargosPersonalizados: {
                        enc13Salario: parseFloat(document.getElementById('enc13Salario').value),
                        encFerias: parseFloat(document.getElementById('encFerias').value),
                        encDSR: parseFloat(document.getElementById('encDSR').value),
                        encINSS: parseFloat(document.getElementById('encINSS').value),
                        encSAT: parseFloat(document.getElementById('encSAT').value),
                        encSalarioEducacao: parseFloat(document.getElementById('encSalarioEducacao').value),
                        encOutros: parseFloat(document.getElementById('encOutros').value),
                        encFGTS: parseFloat(document.getElementById('encFGTS').value),
                        encFGTSMulta: parseFloat(document.getElementById('encFGTSMulta').value)
                    }
                };
                localStorage.setItem('planilhaConfig', JSON.stringify(config));
                
                // N√£o mostrar notifica√ß√£o a cada salvamento para n√£o incomodar o usu√°rio
            } catch (error) {
                console.error('Erro ao salvar dados no localStorage:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                // Carregar dados da planilha
                const savedData = localStorage.getItem('planilhaCustos');
                let dataLoaded = false;
                
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Atualizar categorias com dados salvos
                    parsedData.forEach((savedCategory, index) => {
                        if (index < categories.length) {
                            categories[index].items = savedCategory.items || [];
                        }
                    });
                    
                    dataLoaded = true;
                }
                
                // Carregar configura√ß√µes
                const savedConfig = localStorage.getItem('planilhaConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    // Aplicar tema
                    setTheme(config.theme || 'light');
                    themeToggle.checked = config.theme === 'dark';
                    
                    // Aplicar configura√ß√£o de encargos
                    if (config.encargosType) {
                        encargosSelector.value = config.encargosType;
                        toggleEncargosDetalhados();
                        
                        // Aplicar valores personalizados se necess√°rio
                        if (config.encargosType === 'personalizado' && config.encargosPersonalizados) {
                            document.getElementById('enc13Salario').value = config.encargosPersonalizados.enc13Salario || 8.33;
                            document.getElementById('encFerias').value = config.encargosPersonalizados.encFerias || 11.11;
                            document.getElementById('encDSR').value = config.encargosPersonalizados.encDSR || 0;
                            document.getElementById('encINSS').value = config.encargosPersonalizados.encINSS || 0;
                            document.getElementById('encSAT').value = config.encargosPersonalizados.encSAT || 0;
                            document.getElementById('encSalarioEducacao').value = config.encargosPersonalizados.encSalarioEducacao || 0;
                            document.getElementById('encOutros').value = config.encargosPersonalizados.encOutros || 0;
                            document.getElementById('encFGTS').value = config.encargosPersonalizados.encFGTS || 8;
                            document.getElementById('encFGTSMulta').value = config.encargosPersonalizados.encFGTSMulta || 3.2;
                        }
                    }
                }
                
                if (dataLoaded) {
                    showNotification('Dados carregados com sucesso');
                }
                
                return dataLoaded;
            } catch (error) {
                console.error('Erro ao carregar dados do localStorage:', error);
            }
            return false;
        }

        // Fun√ß√µes para altern√¢ncia de tema
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            saveToLocalStorage();
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(newTheme);
            showNotification(`Tema ${newTheme === 'light' ? 'claro' : 'escuro'} ativado`);
        }

        // Fun√ß√£o para mostrar/ocultar campos de encargos detalhados
        function toggleEncargosDetalhados() {
            const selectedValue = encargosSelector.value;
            
            if (selectedValue === 'personalizado') {
                encargosDetalhados.style.display = 'block';
            } else {
                encargosDetalhados.style.display = 'none';
                
                // Preencher os campos com os valores predefinidos (mesmo que ocultos)
                const config = encargosConfig[selectedValue];
                document.getElementById('enc13Salario').value = config.enc13Salario;
                document.getElementById('encFerias').value = config.encFerias;
                document.getElementById('encDSR').value = config.encDSR;
                document.getElementById('encINSS').value = config.encINSS;
                document.getElementById('encSAT').value = config.encSAT;
                document.getElementById('encSalarioEducacao').value = config.encSalarioEducacao;
                document.getElementById('encOutros').value = config.encOutros;
                document.getElementById('encFGTS').value = config.encFGTS;
                document.getElementById('encFGTSMulta').value = config.encFGTSMulta;
            }
            
            // Atualizar todos os encargos sociais
            updateAllEncargosSociais();
        }

        // Inicializa√ß√£o da aplica√ß√£o
        mainContainer.innerHTML = ''; // Limpar placeholder
        
        // Tentar carregar dados do localStorage
        const dataLoaded = loadFromLocalStorage();
        
        // Renderizar categorias
        categories.forEach(renderCategory);
        
        // Atualizar totais gerais
        updateGrandTotals();

        // Event listeners
        document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
        document.getElementById('exportExcelBtn').addEventListener('click', exportToExcel);
        document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
        document.getElementById('globalSearch').addEventListener('input', filterGlobalSearch);
        
        // Event listener para altern√¢ncia de tema
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'dark' : 'light';
            setTheme(newTheme);
            showNotification(`Tema ${newTheme === 'light' ? 'claro' : 'escuro'} ativado`);
        });
        
        // Event listener para seletor de encargos
        encargosSelector.addEventListener('change', () => {
            toggleEncargosDetalhados();
            saveToLocalStorage();
        });
        
        // Event listeners para campos de encargos personalizados
        document.querySelectorAll('#encargosDetalhados input').forEach(input => {
            input.addEventListener('change', () => {
                updateAllEncargosSociais();
                saveToLocalStorage();
            });
        });

        // Inicializar seletor de encargos
        toggleEncargosDetalhados();

        // Salvar dados automaticamente a cada 30 segundos
        setInterval(saveToLocalStorage, 30000);
        
        // Salvar dados antes de fechar a p√°gina
        window.addEventListener('beforeunload', saveToLocalStorage);
    });
    </script>

</body>
</html>
